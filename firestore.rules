rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- Funciones de Ayuda ---
    function isAuth() { return request.auth != null; }
    function isSelf(uid) { return isAuth() && request.auth.uid == uid; }
    function getRole(uid) { return get(/databases/$(database)/documents/users/$(uid)).data.role; }
    function isAdmin() { return isAuth() && getRole(request.auth.uid) == 'admin'; }
    function isCompliance() { return isAuth() && getRole(request.auth.uid) == 'compliance'; }

    // --- REGLA 2 & 8: Usuarios y Aceptación de Términos ---
    match /users/{userId} {
      allow read, update, delete: if isSelf(userId);
      allow list, get: if isAdmin() || isCompliance();
      allow create: if isSelf(userId) && 
                      request.resource.data.acceptedTerms == true &&
                      request.resource.data.acceptedPrivacy == true;
    }

    // --- REGLA 9: Validación de Choferes ---
    match /drivers/{driverId} {
      allow read: if isSelf(driverId) || isAdmin() || isCompliance();
      allow create: if isSelf(driverId) && request.resource.data.status == 'pending';
      allow update: if (isAdmin() || isCompliance()) && request.resource.data.status != resource.data.status;

      match /documents/{docId} {
        allow read: if isSelf(driverId) || isAdmin();
        allow write: if isAdmin();
      }
    }

    // --- REGLA 1: Viajes ---
    match /trips/{tripId} {
      function isPassenger() { return isAuth() && request.auth.uid == resource.data.passengerId; }
      function isDriver() { return isAuth() && request.auth.uid == resource.data.driverId; }
      
      allow get: if isPassenger() || isDriver();
      allow create: if isAuth() && request.auth.uid == request.resource.data.passengerId && request.resource.data.status == 'pending';
      allow update: if isAdmin() || isCompliance(); // Solo el backend puede cambiar estados

      // --- REGLA 6: Logs (Subcolección) ---
      match /logs/{logId} {
        allow read: if isAuth();
        allow write: if isAdmin();
      }
    }

    // --- REGLA 3: Perfiles de Seguridad ---
    match /safety_profiles/{userId} {
      allow read, write: if isSelf(userId);
    }

    // --- REGLA 4: Viajes Compartidos ---
    match /shared_trips/{shareToken} {
      allow read: if resource.data.isActive == true;
      allow write: if isAdmin();
    }

    // --- REGLA 7: Tarifas ---
    match /fares/tariffs {
        allow read: if isAuth();
        allow create: if isAdmin();
        allow update: if isAdmin() && request.resource.data.active == false; // Solo admin puede desactivar
        allow delete: if false; // No se permite borrar
    }
  }
}