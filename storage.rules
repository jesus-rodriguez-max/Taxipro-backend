rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {

    // Reglas para la subida de audio del Escudo TaxiPro
    match /trip_audio/{tripId}/{userId}/{chunkId} {
      
      function isTripPassenger() {
        // Verifica que el usuario que sube el archivo es el pasajero del viaje
        return exists(/databases/$(database)/documents/trips/$(tripId)) &&
               get(/databases/$(database)/documents/trips/$(tripId)).data.passengerId == request.auth.uid;
      }

      function isComplianceOrAdmin() {
        // Verifica si el usuario tiene el rol de 'compliance' o 'admin'
        let userRole = get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
        return userRole == 'compliance' || userRole == 'admin';
      }

      // PERMISOS:
      // 1. Creación (subida): Solo el pasajero del viaje puede subir archivos de audio.
      //    El `userId` en la ruta debe coincidir con el UID del solicitante.
      allow create: if request.auth != null && request.auth.uid == userId && isTripPassenger();

      // 2. Lectura: Solo personal de compliance o administradores pueden leer/descargar el audio.
      allow read: if request.auth != null && isComplianceOrAdmin();

      // 3. Actualización y Eliminación: Nadie puede modificar o eliminar los chunks de audio para
      //    garantizar la integridad de la evidencia. La eliminación se puede gestionar con
      //    políticas de ciclo de vida de Storage.
      allow update, delete: if false;
    }
  }
}